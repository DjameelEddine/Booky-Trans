<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BooklyTrans ‚Äì Settings</title>
  <!-- FIXED CSP - Allows API calls + scripts -->
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; connect-src *; img-src * data: blob:;">
  <link rel="stylesheet" href="profile.css" />
</head>

<body>
  <!-- Top navigation bar -->
  <header class="topnav">
    <div class="brand">
        <img class="logo" src="../assets/logo.svg" alt="logo" style="
  width: 120px;
  height: 40px;
  margin-top: 10px;
  border-radius: 5px;
  padding: 0px 5px;
"/>
    </div>

    <div class="top-links">
      <span>Community</span>
      <span>How it works</span>
      <span>Contact us</span>
    </div>

    <div class="topnav-right">
      <button class="upload-btn" type="button">Upload a book</button>
       <img class="avatar" src="../assets/profile.svg" alt="User avatar" />
    </div>
  </header>

  <main class="main-container">
    <div class="card-wrapper">
      <!-- Left sidebar -->
      <aside class="sidebar">
        <a href="profile.html" class="side-item">
          <span class="side-icon">üë§</span>
          <span>Profile</span>
        </a>

        <div class="side-item active">
          <span class="side-icon">‚öôÔ∏è</span>
          <span>Settings</span>
        </div>

        <div class="side-item logout" onclick="logout()">
  <span class="side-icon">‚èª</span>
  <span>Log out</span>
</div>

      </aside>

      <!-- Right content area -->
      <section class="content-area">
        <div class="settings-main-layout">
          <!-- Account / Security tabs -->
          <div class="settings-tabs">
            <div class="settings-tab active">Account</div>
            <a href="security.html" class="settings-tab">Security</a>
          </div>

          <!-- Settings card -->
          <div class="settings-card">
            <!-- Username + email in 2 columns -->
            <div class="settings-row-2col">
              <div>
                <label>Username</label>
                <input id="usernameField" type="text" value="" />
              </div>
              <div>
                <label>Email address</label>
                <input id="emailField" type="email" value="" />
              </div>
            </div>

            <!-- Biography (frontend only for now) -->
            <div class="settings-row">
              <label>Biography</label>
              <textarea id="bioField" placeholder="Short bio..."></textarea>
            </div>

            <!-- Avatar + change picture -->
          <div class="settings-avatar-row">
  <div class="settings-avatar">
     <img src="../assets/profile.svg" alt="Profile" style="
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
     ">
  </div>
  <button class="save-btn" type="button" onclick="openAvatarPicker()">Change picture</button>
</div>

<input id="avatarFile" type="file" accept="image/*" style="display:none;" />
          </div>
           
            <!-- hidden file input -->
            <input id="avatarFile2" type="file" accept="image/*" style="display:none;" />
          </div>

          <!-- Buttons -->
          <div class="settings-actions">
            <button class="cancel-btn" type="button" onclick="loadProfile()">Cancel</button>
            <button class="save-btn" type="button" onclick="saveAccount()">Save changes</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const API_BASE = "http://127.0.0.1:8000";

    // later you will set this from /login response
    let ACCESS_TOKEN = localStorage.getItem('access_token') || null;

    function setToken(token) {
      ACCESS_TOKEN = token;
      if (token) {
        localStorage.setItem('access_token', token);
      } else {
        localStorage.removeItem('access_token');
      }
    }

    function authHeaders() {
      return ACCESS_TOKEN
        ? { "Authorization": `Bearer ${ACCESS_TOKEN}` }
        : {};
    }

  function logout() {
  setToken(null);
  window.location.href = "../Home/home.html";  
}

    function loadStoredToken() {
      const token = localStorage.getItem('access_token');
      if (token) {
        ACCESS_TOKEN = token;
      }
    }

    // =
    function quickLogin() {
      fetch(`${API_BASE}/login`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          username: 'admin@example.com',  
          password: 'admin123'            
        })
      })
      .then(r=>r.json())
      .then(data => {
        if (data.access_token) {
          setToken(data.access_token);
          alert('LOGIN SUCCESS! Token saved - Now Save works!');
          console.log('Token:', data.access_token);
        } else {
          alert('Login failed: ' + JSON.stringify(data));
        }
      })
      .catch(err => alert('Error: ' + err));
    }


    async function loadProfile() {
      try {
        const res = await fetch(`${API_BASE}/profile/me`, {
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          }
        });
        if (!res.ok) {
        if (res.status === 401) {
          alert("Please log in first - Click F12 ‚Üí Console ‚Üí quickLogin()");
          return;
        }
        alert("Failed to load profile: " + res.status);
        return;
        }
        const data = await res.json();
        document.getElementById("usernameField").value = data.username || "";
        document.getElementById("emailField").value = data.email || "";
      } catch (err) {
        alert("Error loading profile");
        console.error(err);
      }
    }

    
    async function saveAccount() {
      try {
        const body = {
          username: document.getElementById("usernameField").value.trim(),
          email: document.getElementById("emailField").value.trim()
        };

        if (!body.username || !body.email) {
          alert("Please fill both username and email");
          return;
        }

        const res = await fetch(`${API_BASE}/profile/me`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            ...authHeaders()
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const errorText = await res.text();
          alert("Failed to save: " + errorText + "\n\nCheck token: console.log(localStorage.getItem('access_token'))");
          return;
        }

        const data = await res.json();
        alert("‚úÖ Account saved successfully!");
        console.log("Saved profile:", data);
      } catch (err) {
        alert("Error saving profile: " + err.message);
        console.error(err);
      }
    }

    function openAvatarPicker() {
      const input = document.getElementById("avatarFile");
      if (!input) {
        console.error("avatarFile input not found");
        return;
      }
      input.click();
    }

    // File upload handler
    document.addEventListener("DOMContentLoaded", () => {
      const fileInput = document.getElementById("avatarFile");
      if (fileInput) {
        fileInput.addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            
            const avatarImg = document.querySelector(".settings-avatar img");
            if (avatarImg) {
              avatarImg.src = e.target.result;
            }
          };
          reader.readAsDataURL(file);
        });
      }

    
      loadProfile();
      
  
      const quickBtn = document.createElement('button');
      quickBtn.innerText = ' Quick Login Test';
      quickBtn.style.cssText = 'position:fixed;top:10px;right:10px;z-index:9999;padding:10px;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;';
      quickBtn.onclick = quickLogin;
      document.body.appendChild(quickBtn);
    });
  </script>
</body>
</html>
