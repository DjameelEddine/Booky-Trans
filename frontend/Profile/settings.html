<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BooklyTrans ‚Äì Settings</title>
  <!-- FIXED CSP - Allows API calls + scripts -->
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; connect-src *; img-src * data: blob:;">
  <link rel="stylesheet" href="profile.css" />
</head>

<body>
  <!-- Top navigation bar -->
  <header class="topnav">
    <div class="brand">
        <img class="logo" src="../assets/logo.svg" alt="logo" style="
  width: 120px;
  height: 40px;
  margin-top: 10px;
  border-radius: 5px;
  padding: 0px 5px;
"/>
    </div>

    <div class="top-links">
      <span>Community</span>
      <span>How it works</span>
      <span>Contact us</span>
    </div>

    <div class="topnav-right">
      <button class="upload-btn" type="button">Upload a book</button>
       <img class="avatar" src="../assets/profile.svg" alt="User avatar" />
    </div>
  </header>

  <main class="main-container">
    <div class="card-wrapper">
      <!-- Left sidebar -->
      <aside class="sidebar">
        <a href="profile.html" class="side-item">
          <span class="side-icon">üë§</span>
          <span>Profile</span>
        </a>

        <div class="side-item active">
          <span class="side-icon">‚öôÔ∏è</span>
          <span>Settings</span>
        </div>

        <div class="side-item logout" onclick="logout()">
  <span class="side-icon">‚èª</span>
  <span>Log out</span>
</div>

      </aside>

      <!-- Right content area -->
      <section class="content-area">
        <div class="settings-main-layout">
          <!-- Account / Security tabs -->
          <div class="settings-tabs">
            <div class="settings-tab active">Account</div>
            <a href="security.html" class="settings-tab">Security</a>
          </div>

          <!-- Settings card -->
          <div class="settings-card">
            <!-- Username + email in 2 columns -->
            <div class="settings-row-2col">
              <div>
                <label>Username</label>
                <input id="usernameField" type="text" value="" />
              </div>
              <div>
                <label>Email address</label>
                <input id="emailField" type="email" value="" />
              </div>
            </div>

            <!-- Biography (frontend only for now) -->
            <div class="settings-row">
              <label>Biography</label>
              <textarea id="bioField" placeholder="Short bio..."></textarea>
            </div>

            <!-- Avatar + change picture -->
          <div class="settings-avatar-row">
  <div class="settings-avatar">
     <img src="../assets/profile.svg" alt="Profile" style="
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
     ">
  </div>
  <button class="save-btn" type="button" onclick="openAvatarPicker()">Change picture</button>
</div>

<input id="avatarFile" type="file" accept="image/*" style="display:none;" />
          </div>
           
            <!-- hidden file input -->
            <input id="avatarFile2" type="file" accept="image/*" style="display:none;" />
          </div>

          <!-- Buttons -->
          <div class="settings-actions">
            <button class="cancel-btn" type="button" onclick="loadProfile()">Cancel</button>
            <button class="save-btn" type="button" onclick="saveAccount()">Save changes</button>
          </div>
        </div>
      </section>
    </div>
  </main>

 <script>
  const API_BASE = "http://127.0.0.1:8000";

  
  function authHeaders() {
    return { "Content-Type": "application/json" };
  }

  function logout() {
    window.location.href = "../Home/home.html"; 
  }

  async function loadProfile() {
    try {
      const res = await fetch(`${API_BASE}/profile/me`, {
        headers: authHeaders()  
      });
      
      if (!res.ok) {
        console.log("No profile data - demo mode");
      
        document.getElementById("usernameField").value = "demo_user";
        document.getElementById("emailField").value = "demo@example.com";
        return;
      }
      
      const data = await res.json();
      document.getElementById("usernameField").value = data.username || "demo_user";
      document.getElementById("emailField").value = data.email || "demo@example.com";
    } catch (err) {
      console.log("Demo mode - no backend");
      document.getElementById("usernameField").value = "demo_user";
      document.getElementById("emailField").value = "demo@example.com";
    }
  }

  async function saveAccount() {
    try {
      const body = {
        username: document.getElementById("usernameField").value.trim(),
        email: document.getElementById("emailField").value.trim()
      };

      if (!body.username || !body.email) {
        alert("Please fill both username and email");
        return;
      }

      const res = await fetch(`${API_BASE}/profile/me`, {
        method: "PUT",
        headers: authHeaders(), 
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const errorText = await res.text();
        alert("Save failed (demo mode): " + errorText);
        return;
      }

      alert(" Account saved successfully!");
      console.log("Saved:", body);
    } catch (err) {
      alert(" Demo save complete!");
    }
  }

  function openAvatarPicker() {
    const input = document.getElementById("avatarFile");
    if (input) input.click();
  }

 
  document.addEventListener("DOMContentLoaded", () => {
    const fileInput = document.getElementById("avatarFile");
    if (fileInput) {
      fileInput.addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const avatarImg = document.querySelector(".settings-avatar img");
          if (avatarImg) avatarImg.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    loadProfile();  
  });
</script>

</body>
</html>
